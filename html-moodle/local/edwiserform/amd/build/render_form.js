"use strict";define(["jquery","core/ajax","local_edwiserform/form_styles","local_edwiserform/iefixes","local_edwiserform/formviewer"],function(e,t,i){var a={CONTAINER:".edwiserform-container",FULLPAGE:"#edwiserform-fullpage",UPLOADED_FILE:"efb-uploaded-file",DELETE_FILE:"efb-delete-user-file",DELETE_CANCEL:"efb-delete-user-file-cancel",FILE:'input[type="file"]',COMPONENT:"local_edwiserform"},n={DATA_DELETING:"data-deleting",DATA_PROCESSING:"data-processing"},r={container:"",countries:"undefined"==typeof countries?null:countries,localStorage:!1},o=[],s=e(a.CONTAINER),l=e(a.FULLPAGE)&&e(a.FULLPAGE).val(),c={GET_FORM_DEFINITION:function(e){return t.call([{methodname:"edwiserform_get_form_definition",args:{form_id:e,countries:void 0===window.countries||!0}}])[0]},SUBMIT_FORM_DATA:function(e,i){return t.call([{methodname:"edwiserform_submit_form_data",args:{formid:e,data:i}}])[0]},UPLOAD_FILE:function(t){var i=new FormData;return i.append("sesskey",M.cfg.sesskey),i.append(0,t),e.ajax({url:M.cfg.wwwroot+"/local/edwiserform/upload.php",type:"POST",data:i,cache:!1,async:!1,dataType:"json",processData:!1,contentType:!1})}};function f(t,i,a,n,r,o,s){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;e(a).text(r),c.SUBMIT_FORM_DATA(o,s).done(function(r){if(r.status){if(void 0!==r.data&&""!=r.data){if(data=JSON.parse(r.data),"redirect"==data.action)return void(window.location.href=data.url);if("confirmredirect"==data.action)return void(""!=r.msg?i.dom.alert("warning",r.msg,function(){window.location.href=data.url}):window.location.href=data.url)}e(t).html(r.msg),i.dom.alert("success",r.msg),null!=l&&l(t,s),e("#edwiser-activity")&&1==e("#edwiser-activity").val()&&e("body").trigger({type:"formSubmitted",cmid:e("#cmid").val()})}else""!=r.msg&&i.dom.alert("warning",r.msg),r.hasOwnProperty("errors")&&function(t,i){i=JSON.parse(i),e(".custom-validation-error").remove(),e.each(i,function(i,a){var n=e(t).find("#"+i+"-error");0==n.length&&(e(t).find('[name="'+i+'"]').after('<span id="'+i+'-error" class="text-error custom-validation-error"></span>'),n=e(t).find("#"+i+"-error")),n.text(a)})}(t,r.errors);i.dom.loadingClose(),e(a).text(n)}).fail(function(t){e(a).text(n),i.dom.loadingClose(),e(a).text(n)})}function d(t,i,r){var o=e(t).closest("form"),s=t,l=i.dom.checkValidity(o[0]),d=e(t).text(),u=e(t).attr(n.DATA_PROCESSING),m=e(o).parent().find(".id").val();if(l){if(""!=e(o).attr("action"))return e(o).submit(),!0;r.preventDefault(),i.dom.loading(),setTimeout(function(){var t=o.serializeArray();t=function(e){var t=["g-recaptcha-response"],i=[];return e.forEach(function(e,a){-1==t.indexOf(e.name)&&i.push(e)}),JSON.stringify(i)}(t=function(t,i){var r=e(t).find(a.FILE);return e.each(r,function(t,a){0!=a.files.length?c.UPLOAD_FILE(a.files[0]).done(function(t){1==t.status&&i.push({name:e(a).attr("name"),type:"file",value:t.itemid})}).fail(function(e){console.log(e)}):"true"==e(a).attr(n.DATA_DELETING)?i.push({name:e(a).attr("name"),type:"file",value:0,delete:!0}):i.push({name:e(a).attr("name"),type:"file",value:0})}),i}(o,t)),f(o,i,s,d,u,m,t)},1e3)}return!1}function u(t){r.sitekey=t,e.each(s,function(t,n){var s=e(n).parent().find(".id").val();c.GET_FORM_DEFINITION(s).done(function(s){0!=s.status?(void 0!==window.countries&&0!=window.countries||void 0===s.countries||0==s.countries||(window.countries=JSON.parse(s.countries),r.countries=countries),r.container=n,o[t]=new Formeo(r,s.definition),o[t].render(n),e(n).prepend("<h2 class='form-header'>"+s.title+"</h2>"),s.data&&function(t,i){var n=JSON.parse(i);e.each(n,function(i,n){e.each(e(t).find('[name="'+n.name+'"]'),function(t,i){switch(i.tagName){case"INPUT":switch(i.type){case"radio":i.value==n.value&&e(i).prop("checked",!0);var r=new CustomEvent("click",{target:e(i)[0]});e(i)[0].dispatchEvent(r);break;case"checkbox":i.value==n.value&&e(i).prop("checked",!0);break;case"file":0!=n.value&&(e(i).after('<span class="efb-delete-user-file-notice">'+M.util.get_string("delete-userfile-on-save-notice",a.COMPONENT)+"</span>"),e(i).after('<a href="#" class="'+a.DELETE_CANCEL+'">'+M.util.get_string("cancel-delete-userfile",a.COMPONENT)+"</a>"),e(i).after('<a href="#"  class="'+a.DELETE_FILE+'">'+M.util.get_string("efb-form-action-delete-title",a.COMPONENT)+"</a>"),e(i).after('<a class="'+a.UPLOADED_FILE+'" target="_blank" href="'+n.value+'">'+n.filename+"</a>"));break;default:e(i).val(n.value)}break;case"SELECT":if(e(i).is('[multiple="true"]')){var o=e(i).val();o.push(n.value),n.value=o}case"TEXTAREA":e(i).val(n.value)}r=new CustomEvent("change",{target:e(i)[0]}),e(i)[0].dispatchEvent(r),""!=e(i).val()&&e(i).parents(".f-field-group").addClass("active")})})}(n,s.data),i.apply(e(n).find(".formeo-render"),"add",s.style),s.action&&""!=s.action&&function(t,i){e(t).attr("action",i)}(n,s.action),e(n).submit(function(e){return d(this,o[t],e)}).find("#submit-form").click(function(){return d(this,o[t],event)})):e(n).html(s.msg).addClass("empty")}).fail(Notification.exception)})}return{init:function(t){e(document).ready(function(i){0!=e("#edwiserform-fullpage").length&&1==e("#edwiserform-fullpage").val()&&e("body").addClass("edwiserform-fullpage"),u(t),e(window).resize(function(){e.each(s,function(e){void 0!==o[e]&&o[e].dom.manageFormWidth(l)})}),e(".step-navigation #previous-step, .step-navigation #next-step").click(function(){}),e("body").on("click","."+a.DELETE_FILE,function(t){t.preventDefault(),e(this).siblings(a.FILE).attr(n.DATA_DELETING,!0)}).on("click","."+a.DELETE_CANCEL,function(t){t.preventDefault(),e(this).siblings(a.FILE).attr(n.DATA_DELETING,!1)}).on("change",a.FILE,function(){var t=this;if(0!=e(this)[0].files.length&&e(this).next().hasClass(a.UPLOADED_FILE)){var i=e.inArray(e(t).parents(a.CONTAINER)[0],e(a.CONTAINER));o[i].dom.multiActions("warning",M.util.get_string("attention",a.COMPONENT),M.util.get_string("user-file-replace",a.COMPONENT,e(this).find("h4").text()),[{title:M.util.get_string("proceed",a.COMPONENT),type:"warning"},{title:M.util.get_string("cancel",a.COMPONENT),type:"primary",action:function(){e(t).val("")}}])}}).on("click",".efb-view-fullpage",function(){var t=e(this).closest(a.CONTAINER).parent().find('input[class="id"]').val();window.open(M.cfg.wwwroot+"/local/edwiserform/form.php?id="+t),e(this).closest(a.CONTAINER).html(M.util.get_string("fullpage-link-clicked",a.COMPONENT))})})}}});
//# sourceMappingURL=render_form.js.map
