{"version":3,"file":"manage_courses.min.js","sources":["../src/manage_courses.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable no-unused-vars */\n/* eslint-disable max-len */\n/* eslint-disable no-undef */\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/modal_factory',\n    'core/modal_save_cancel',\n    'core/modal_events',\n    'block_remuiblck/manage_courses_view',\n    'block_remuiblck/manage_courses_filters',\n    'block_remuiblck/chartjs',\n    'block_remuiblck/jquery.dataTables',\n    'block_remuiblck/dataTables.bootstrap4'\n], function(\n    $,\n    ajax,\n    Notification,\n    ModalFactory,\n    ModalSaveCancel,\n    ModalEvents,\n    ManageCoursesView,\n    ManageCoursesFilters\n) {\n\n    var SELECTORS = {\n        VIEW_REPORT: '.remui-view-course-report',\n        STATS_TAB: '#wdm-userstats',\n        STATS_TABLE: '#userstats-table',\n        EXPORT_WRAPPER: '#userstats-table_wrapper .wdm-export-buttons',\n        EXPORT: '.wdm-manage-course-export-csv',\n        STATS_CHART: '#coursestats-chart',\n        STATS_FILTER_INPUT: '#userstats-table_filter input',\n        DROPPING_STUDENT_MESSAGE: '.dropping-student-message'\n    };\n\n    var PROMISES = {\n        /**\n         * Get course report promise\n         * @param  {int} courseid Course id\n         * @return {promise}           Ajax promise object\n         */\n        GET_COURSE_REPORT: function(courseid) {\n            return ajax.call([{\n                methodname: 'block_remuiblck_get_course_report',\n                args: {\n                    courseid: courseid\n                }\n            }])[0];\n        },\n\n        /**\n         * Get dropping off students list promise\n         * @param {int}     courseid Course id\n         * @param {String}  search   Search query\n         * @param {int}     length   Number of rows per page\n         * @param {int}     start    Starting row number\n         * @param {object}  order    Sorting order\n         * @return {promise}           Ajax promise object\n         */\n        GET_DROPPING_OFF_STUDENTS: function(courseid, search, length, start, order) {\n            return ajax.call([{\n                methodname: 'block_remuiblck_get_dropping_off_students',\n                args: {\n                    courseid: courseid,\n                    search: search,\n                    length: length,\n                    start: start,\n                    order: order\n                }\n            }])[0];\n        },\n\n        /**\n         * Export dropping off students list promise\n         * @param {int}     courseid Course id\n         * @param {string}  search   search query\n         * @return {promise}           Ajax promise object\n         */\n        EXPORT_DROPPING_OFF_STUDENTS: function(courseid, search) {\n            return ajax.call([{\n                methodname: 'block_remuiblck_export_dropping_off_students',\n                args: {\n                    courseid: courseid,\n                    search: search\n                }\n            }])[0];\n        },\n        /**\n         * Send message to student using student id and ajax\n         * @param  {Number} studentid   Student id\n         * @param  {String} messagetext Message text\n         * @return {Promise}            Ajax promise\n         */\n        SEND_MESSAGE: function(studentid, messagetext) {\n            return ajax.call([{\n                methodname: 'block_remuiblck_send_message',\n                args: {\n                    studentid: studentid,\n                    messagetext: messagetext\n                }\n            }])[0];\n        }\n    };\n    $('body').on('click', SELECTORS.VIEW_REPORT, function() {\n        event.preventDefault();\n        var _this = this;\n        var trigger = $('#create-modal');\n        ModalFactory.create({\n            title: $(_this).attr('title')\n        }, trigger).done(function(modal) {\n            modal.modal.addClass('modal-lg');\n\n            // Destroy when hidden.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.destroy();\n            }).addClass('fade');\n\n            // Show loading icon till load modal body\n            modal.setBody('<i class=\"fa fa-circle-o-notch fa-spin fa-fw\" aria-hidden=\"true\"></i>');\n\n            // Fetch body using ajax request\n            PROMISES.GET_COURSE_REPORT($(_this).data('course-id'))\n            .done(function(response) {\n                modal.setBody(response);\n                if (modal.getRoot().find(SELECTORS.STATS_CHART).length != 0) {\n                    var ctx = modal.getRoot().find(SELECTORS.STATS_CHART)[0].getContext('2d');\n                    new Chart(ctx, {\n                        type: 'doughnut',\n                        data: {\n                            labels: [\n                                M.util.get_string('studentcompleted', 'block_remuiblck'),\n                                M.util.get_string('inprogress', 'block_remuiblck'),\n                                M.util.get_string('yettostart', 'block_remuiblck')\n                            ],\n                            datasets: [{\n                                backgroundColor: [\n                                    studentcompletedcolor,\n                                    inprogresscolor,\n                                    yettostartcolor\n                                ],\n                                data: [\n                                    modal.getRoot().find(SELECTORS.STATS_CHART).data('studentcompleted'),\n                                    modal.getRoot().find(SELECTORS.STATS_CHART).data('inprogress'),\n                                    modal.getRoot().find(SELECTORS.STATS_CHART).data('yettostart')\n                                ]\n                            }]\n                        },\n                        options: {\n                            legend: {\n                                display: false\n                            }\n                        }\n                    });\n                }\n            })\n            .fail(Notification.exception);\n\n            // Show modal\n            setTimeout(modal.show(), 100);\n        });\n        return;\n    }).on('click', SELECTORS.STATS_TAB, function() {\n        if ($(SELECTORS.STATS_TABLE).is('.dataTable')) {\n            return;\n        }\n        $(SELECTORS.STATS_TABLE).DataTable({\n            \"bPaginate\": true,\n            \"bServerSide\": true,\n            \"language\": {\n                \"searchPlaceholder\": M.util.get_string('searchnameemail', 'block_remuiblck'),\n                \"emptyTable\": M.util.get_string('nostudentsenrolled', 'block_remuiblck')\n            },\n            \"dom\": '<\"wdm-export-buttons\">frtip',\n            \"initComplete\": function(settings, json) {\n                $(SELECTORS.EXPORT_WRAPPER).append(\n                    \"<button class='wdm-manage-course-export-csv btn btn-primary' data-course-id='\" + $(this).data('course-id') + \"'>\" + M.util.get_string(\n                        'exportcsv',\n                        'block_remuiblck'\n                    ) + \"</button>\"\n                );\n            },\n            \"ajax\": function(data, callback, settings) {\n                PROMISES.GET_DROPPING_OFF_STUDENTS(\n                    $(this).data('course-id'),\n                    data.search.value,\n                    data.length,\n                    data.start,\n                    data.order[0]\n                ).done(function(response) {\n                    callback(response);\n                }).fail(Notification.exception);\n            },\n            \"columns\": [\n                {\"className\": \"pb-0 pt-0\", \"data\": \"name\"},\n                {\"className\": \"pb-0 pt-0\", \"data\": \"email\"},\n                {\"className\": \"pb-0 pt-0\", \"data\": \"enroltimestart\"},\n                {\"className\": \"pb-0 pt-0\", \"data\": \"lastaccess\"}\n            ],\n            \"rowCallback\": function(row, data, index) {\n                if (index % 2 == 0) {\n                    $(row).addClass('bg-grey-100');\n                } else {\n                    $(row).addClass('bg-grey-200');\n                }\n            }\n        });\n    }).on('click', SELECTORS.EXPORT, function() {\n        var _this = this;\n        PROMISES.EXPORT_DROPPING_OFF_STUDENTS(\n            $(_this).data('course-id'),\n            $(SELECTORS.STATS_FILTER_INPUT).val()\n        ).done(function(response) {\n            var file = $('<a></a>');\n            $('body').append(file);\n            $(file).attr('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(response.filedata));\n            $(file).attr('download', response.filename).hide()[0].click();\n            $(file).remove();\n        }).fail(Notification.exception);\n    }).on('click', SELECTORS.DROPPING_STUDENT_MESSAGE, function() {\n        var _this = this;\n        var trigger = $('#create-modal');\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: M.util.get_string('sendmessage', 'core_message')\n        }, trigger).done(function(modal) {\n\n            // Set button text as send\n            modal.setSaveButtonText(M.util.get_string('send', 'core_message'));\n\n            // Add textarea field in body\n\n            modal.setBody('<label>' + M.util.get_string('sendmessageto', 'core_message', $($(_this).parent('td').siblings()[0]).html()) + '</label><textarea class=\"form-control message\" rows=\"5\" autocomplete=\"off\"></textarea>');\n\n            // Destroy when hidden.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.destroy();\n            });\n\n            // Send message when save button is clicked\n            modal.getRoot().on(ModalEvents.save, function(event) {\n                var studentid = $(_this).data('student-id');\n                var message = $(this).find('.message').val();\n                if (message != '') {\n                    PROMISES.SEND_MESSAGE(studentid, message)\n                    .done(function(response) {\n                        modal.destroy();\n                    })\n                    .fail(function(ex) {\n                        Notification.exception(ex);\n                    });\n                }\n            }).addClass('modal-success fade');\n            modal.modal.addClass('modal-center');\n\n            // Show modal\n            setTimeout(modal.show(), 100);\n        });\n    });\n\n    $(\"#manage_courses\").on('click', \".menu-picker-select\", function() {\n        $(this).find(\".menu-content\").toggleClass('d-none');\n        $(this).find(\".edw-icon-more\").toggleClass('d-none');\n        $(this).find(\".edw-icon-Cancel\").toggleClass('d-none');\n    });\n    var init = function (root) {\n        $(document).ready(function () {\n            ManageCoursesView.init(root);\n            ManageCoursesFilters.init(root);\n        });\n    };\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","ajax","Notification","ModalFactory","ModalSaveCancel","ModalEvents","ManageCoursesView","ManageCoursesFilters","SELECTORS","PROMISES","courseid","call","methodname","args","search","length","start","order","studentid","messagetext","on","event","preventDefault","_this","this","trigger","create","title","attr","done","modal","addClass","getRoot","hidden","destroy","setBody","data","response","find","ctx","getContext","Chart","type","labels","M","util","get_string","datasets","backgroundColor","studentcompletedcolor","inprogresscolor","yettostartcolor","options","legend","display","fail","exception","setTimeout","show","is","DataTable","settings","json","append","callback","value","row","index","val","file","encodeURIComponent","filedata","filename","hide","click","remove","types","SAVE_CANCEL","setSaveButtonText","parent","siblings","html","save","message","ex","toggleClass","init","root","document","ready"],"mappings":"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"}