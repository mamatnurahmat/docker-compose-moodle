define("block_remuiblck/manage_courses",["jquery","core/ajax","core/notification","core/modal_factory","core/modal_save_cancel","core/modal_events","block_remuiblck/manage_courses_view","block_remuiblck/manage_courses_filters","block_remuiblck/chartjs","block_remuiblck/jquery.dataTables","block_remuiblck/dataTables.bootstrap4"],(function($,ajax,Notification,ModalFactory,ModalSaveCancel,ModalEvents,ManageCoursesView,ManageCoursesFilters){var SELECTORS_VIEW_REPORT=".remui-view-course-report",SELECTORS_STATS_TAB="#wdm-userstats",SELECTORS_STATS_TABLE="#userstats-table",SELECTORS_EXPORT_WRAPPER="#userstats-table_wrapper .wdm-export-buttons",SELECTORS_EXPORT=".wdm-manage-course-export-csv",SELECTORS_STATS_CHART="#coursestats-chart",SELECTORS_STATS_FILTER_INPUT="#userstats-table_filter input",SELECTORS_DROPPING_STUDENT_MESSAGE=".dropping-student-message",PROMISES_GET_COURSE_REPORT=function(courseid){return ajax.call([{methodname:"block_remuiblck_get_course_report",args:{courseid:courseid}}])[0]},PROMISES_GET_DROPPING_OFF_STUDENTS=function(courseid,search,length,start,order){return ajax.call([{methodname:"block_remuiblck_get_dropping_off_students",args:{courseid:courseid,search:search,length:length,start:start,order:order}}])[0]},PROMISES_EXPORT_DROPPING_OFF_STUDENTS=function(courseid,search){return ajax.call([{methodname:"block_remuiblck_export_dropping_off_students",args:{courseid:courseid,search:search}}])[0]},PROMISES_SEND_MESSAGE=function(studentid,messagetext){return ajax.call([{methodname:"block_remuiblck_send_message",args:{studentid:studentid,messagetext:messagetext}}])[0]};$("body").on("click",SELECTORS_VIEW_REPORT,(function(){event.preventDefault();var _this=this,trigger=$("#create-modal");ModalFactory.create({title:$(_this).attr("title")},trigger).done((function(modal){modal.modal.addClass("modal-lg"),modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})).addClass("fade"),modal.setBody('<i class="fa fa-circle-o-notch fa-spin fa-fw" aria-hidden="true"></i>'),PROMISES_GET_COURSE_REPORT($(_this).data("course-id")).done((function(response){if(modal.setBody(response),0!=modal.getRoot().find(SELECTORS_STATS_CHART).length){var ctx=modal.getRoot().find(SELECTORS_STATS_CHART)[0].getContext("2d");new Chart(ctx,{type:"doughnut",data:{labels:[M.util.get_string("studentcompleted","block_remuiblck"),M.util.get_string("inprogress","block_remuiblck"),M.util.get_string("yettostart","block_remuiblck")],datasets:[{backgroundColor:[studentcompletedcolor,inprogresscolor,yettostartcolor],data:[modal.getRoot().find(SELECTORS_STATS_CHART).data("studentcompleted"),modal.getRoot().find(SELECTORS_STATS_CHART).data("inprogress"),modal.getRoot().find(SELECTORS_STATS_CHART).data("yettostart")]}]},options:{legend:{display:!1}}})}})).fail(Notification.exception),setTimeout(modal.show(),100)}))})).on("click",SELECTORS_STATS_TAB,(function(){$(SELECTORS_STATS_TABLE).is(".dataTable")||$(SELECTORS_STATS_TABLE).DataTable({bPaginate:!0,bServerSide:!0,language:{searchPlaceholder:M.util.get_string("searchnameemail","block_remuiblck"),emptyTable:M.util.get_string("nostudentsenrolled","block_remuiblck")},dom:'<"wdm-export-buttons">frtip',initComplete:function(settings,json){$(SELECTORS_EXPORT_WRAPPER).append("<button class='wdm-manage-course-export-csv btn btn-primary' data-course-id='"+$(this).data("course-id")+"'>"+M.util.get_string("exportcsv","block_remuiblck")+"</button>")},ajax:function(data,callback,settings){PROMISES_GET_DROPPING_OFF_STUDENTS($(this).data("course-id"),data.search.value,data.length,data.start,data.order[0]).done((function(response){callback(response)})).fail(Notification.exception)},columns:[{className:"pb-0 pt-0",data:"name"},{className:"pb-0 pt-0",data:"email"},{className:"pb-0 pt-0",data:"enroltimestart"},{className:"pb-0 pt-0",data:"lastaccess"}],rowCallback:function(row,data,index){index%2==0?$(row).addClass("bg-grey-100"):$(row).addClass("bg-grey-200")}})})).on("click",SELECTORS_EXPORT,(function(){PROMISES_EXPORT_DROPPING_OFF_STUDENTS($(this).data("course-id"),$(SELECTORS_STATS_FILTER_INPUT).val()).done((function(response){var file=$("<a></a>");$("body").append(file),$(file).attr("href","data:text/plain;charset=utf-8,"+encodeURIComponent(response.filedata)),$(file).attr("download",response.filename).hide()[0].click(),$(file).remove()})).fail(Notification.exception)})).on("click",SELECTORS_DROPPING_STUDENT_MESSAGE,(function(){var _this=this,trigger=$("#create-modal");ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:M.util.get_string("sendmessage","core_message")},trigger).done((function(modal){modal.setSaveButtonText(M.util.get_string("send","core_message")),modal.setBody("<label>"+M.util.get_string("sendmessageto","core_message",$($(_this).parent("td").siblings()[0]).html())+'</label><textarea class="form-control message" rows="5" autocomplete="off"></textarea>'),modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal.getRoot().on(ModalEvents.save,(function(event){var studentid=$(_this).data("student-id"),message=$(this).find(".message").val();""!=message&&PROMISES_SEND_MESSAGE(studentid,message).done((function(response){modal.destroy()})).fail((function(ex){Notification.exception(ex)}))})).addClass("modal-success fade"),modal.modal.addClass("modal-center"),setTimeout(modal.show(),100)}))})),$("#manage_courses").on("click",".menu-picker-select",(function(){$(this).find(".menu-content").toggleClass("d-none"),$(this).find(".edw-icon-more").toggleClass("d-none"),$(this).find(".edw-icon-Cancel").toggleClass("d-none")}));return{init:function(root){$(document).ready((function(){ManageCoursesView.init(root),ManageCoursesFilters.init(root)}))}}}));

//# sourceMappingURL=manage_courses.min.js.map