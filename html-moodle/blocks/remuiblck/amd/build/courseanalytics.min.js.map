{"version":3,"file":"courseanalytics.min.js","sources":["../src/courseanalytics.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable max-len */\n/* eslint-disable no-undef */\n/* eslint-disable no-loop-func */\n/* eslint-disable jsdoc/check-param-names */\n/* eslint-disable no-unused-vars */\n\n\ndefine([\n    'block_remuiblck/jquery',\n    'core/ajax',\n    'block_remuiblck/chartjs',\n    'core/custom_interaction_events',\n    'block_remuiblck/events'\n], function ($, Ajax, Chart, CustomEvents, RemuiblckEvents) {\n\n    var SELECTORS = {\n        PAGECOUNT: '[data-action-page-count]',\n        PAGINATE: '[data-action-paginate]',\n        NEXT: '[data-next]',\n        PREVIOUS: '[data-previous]',\n        CHARTPAGINATION: '.analysis-chart-pagination',\n        PAGES: '[data-region-pages]',\n        TOGGLELABELS: '#togglelabels',\n        PER_PAGE_FILTER: '[data-region=\"per-page-filter\"]',\n        FILTER_OPTION: '[data-value]'\n    };\n    window['analysisChart'] = null;\n    var pageNumber = 1;\n    var maxPage = 1;\n    /* Course Analytics Block */\n    var analysisBar;\n\n    /**\n     * Get start and end index of bar data\n     *\n     * @param  {Number} perPage Total number of bars per page\n     * @return {Object}         Object with start and end value of bars\n     */\n    function getStartEnd(perPage) {\n        // default limit is 0\n        var limit = {\n            start: 0,\n            end: 0\n        };\n        if (analysisBar.labels == undefined) {\n            return limit;\n        }\n        // if number of bars is less or equal to per page then return limit with 1 and bars count\n        if (analysisBar.labels.length <= perPage) {\n            limit.start = 1;\n            limit.end = analysisBar.labels.length;\n            return limit;\n        }\n        limit.start = pageNumber == 1 ? 1 : (pageNumber - 1) * perPage + 1;\n        limit.end = pageNumber * perPage;\n        if (analysisBar.labels.length < limit.end) {\n            limit.end = analysisBar.labels.length;\n        }\n        return limit;\n    }\n\n    /**\n     * Update bars data in the chart based on start and end of bars\n     *\n     * @param {String} root      block root element id\n     * @param {Number} totalBars Total bar which can be shown in the chart\n     */\n    function updateBars(root, totalBars) {\n        // var {start, end} = getStartEnd(totalBars);\n        var limit = getStartEnd(totalBars);\n        // Update pagination label\n        $(root).find(SELECTORS.PAGES).text(M.util.get_string('showingfromto', 'block_remuiblck', {\n            start: limit.start,\n            to: limit.end,\n            total: analysisBar.labels.length\n        }));\n\n        // Remove previous bar data\n        analysisChart.data.labels = [];\n        analysisChart.data.datasets.forEach(function(dataset) {\n            dataset.data = [];\n        });\n        analysisChart.update();\n\n        // Add new bar data and re-render the chart\n        for (var i = limit.start - 1; i <= limit.end; i++) {\n            analysisChart.data.labels.push(analysisBar.labels[i]);\n            analysisChart.data.datasets.forEach(function(dataset, index) {\n                dataset.data.push(analysisBar.datasets[index].data[i]);\n            });\n            analysisChart.update();\n        }\n    }\n\n    /**\n     * Generate pagination data on page load\n     * @param {String} root    block root element id\n     * @param {Number} perPage bars to be shown per page\n     */\n    function generatePagination(root, perPage) {\n        // If there is no data then hide pagination and return\n        if (analysisBar.labels == undefined) {\n            $(root).find(SELECTORS.CHARTPAGINATION).addClass('d-none');\n            return;\n        }\n        pageNumber = 1;\n        // var {start, end} = getStartEnd(perPage);\n\n        // Show pagination\n        $(root).find(SELECTORS.CHARTPAGINATION).removeClass('d-none');\n        maxPage = analysisBar.labels.length > perPage ? Math.round(analysisBar.labels.length / perPage) : 1;\n        updateBars(root, perPage);\n    }\n\n    /**\n     * Get Analysis Data using ajax\n     *\n     * @param  {String} root block root element id\n     * @return {Ajax}   Ajax promise\n     */\n    function getAnalysisData(root) {\n        var course_id = $(root).find('#coursecategorylist option:selected').data('id');\n        return Ajax.call([{\n            methodname: 'block_remuiblck_get_course_analytics',\n            args: {\n                courseid: course_id\n            }\n        }])[0];\n    }\n\n    /**\n     * Create analysis chart from ajax data\n     *\n     * @param {String} root block root element id\n     */\n    function createAnalysisChart(root) {\n        getAnalysisData(root)\n        .done(function (response) {\n            analysisBar = response;\n            pageNumber = 1;\n            if (analysisChart !== null) {\n                analysisChart.destroy();\n            }\n\n            if (response.error) {\n                $(root).find(\"#highestactivity\").html(\"\");\n                $(root).find(\"#lowestactivity\").html(\"\");\n\n                $(root).find(\"#highestgrade\").html(\"0\");\n                $(root).find(\"#lowestgrade\").html(\"0\");\n                $(root).find(\"#averagegrade\").html(\"0\");\n            } else {\n                $(root).find(\"#highestactivity\").html(analysisBar.maxactivityname);\n                $(root).find(\"#lowestactivity\").html(analysisBar.minactivityname);\n\n                $(root).find(\"#highestgrade\").html(analysisBar.highest);\n                $(root).find(\"#lowestgrade\").html(analysisBar.lowest);\n                $(root).find(\"#averagegrade\").html(analysisBar.average);\n            }\n\n            var context = $(root).find(\"#analysischart\").get(0).getContext(\"2d\");\n            var datasets = [];\n            if (response.datasets != undefined) {\n                response.datasets.forEach(function(dataset) {\n                    datasets.push({\n                        data: [],\n                        backgroundColor: dataset.backgroundColor,\n                        label: dataset.label\n                    });\n                });\n            }\n            context.canvas.height = 400;\n            analysisChart = new Chart(context, {\n                data: {\n                    labels: [],\n                    datasets: datasets\n                },\n                type: 'bar',\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    tooltips: {\n                        enabled: true\n                    },\n                    hover: {\n                        animationDuration: 0\n                    },\n                    layout: {\n                        padding: {\n                            top: 20\n                        }\n                    },\n                    legend: {\n                        position: 'bottom',\n                        labels: {\n                            padding: 20,\n                            fontSize: 12\n                        }\n\n                    },\n                    animation: {\n                        duration: 300,\n                        easing: 'easeInOutQuad',\n                        onComplete: function () {\n                            var chartInstance = this.chart,\n                                ctx = chartInstance.ctx;\n                            ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);\n                            ctx.textAlign = 'center';\n                            ctx.textBaseline = 'bottom';\n\n                            this.data.datasets.forEach(function (dataset, i) {\n                                var meta = chartInstance.controller.getDatasetMeta(i);\n                                if (meta.hidden != true) {\n                                    meta.data.forEach(function (bar, index) {\n                                        var data = dataset.data[index];\n                                        ctx.fillText(data, bar._model.x, bar._model.y - 5);\n                                    });\n                                }\n                            });\n                        }\n                    },\n                    scales:\n                    {\n                        xAxes: [{\n                            display: false,\n                            gridLines: {\n                                display: true,\n                            },\n                            barThickness: 38,\n                        }],\n                        yAxes: [{\n                            ticks: {\n                                beginAtZero: true,\n                            },\n                            gridLines: {\n                                display: true\n                            },\n                        }]\n                    }\n                }\n            });\n            generatePagination(root, getCourseAnalyticsPerPage(root));\n        })\n        .fail(function (xhr, status, error) {\n            $(root).find('div#analysis-chart-area').hide();\n        });\n    }\n\n    /**\n     * Event listener for the per page selector\n     *\n     * @param {object} root The root element for the manage courses block\n     */\n    var registerCourseAnalyticsPerPageFilter = function(root) {\n        var courseAnalyticsPerPageFilterContainer = $(root).find(SELECTORS.PER_PAGE_FILTER);\n        CustomEvents.define(courseAnalyticsPerPageFilterContainer, [CustomEvents.events.activate]);\n        courseAnalyticsPerPageFilterContainer.on(\n            CustomEvents.events.activate,\n            SELECTORS.FILTER_OPTION,\n            function(e, data) {\n                data.originalEvent.preventDefault();\n\n                var option = $(e.target).closest(SELECTORS.FILTER_OPTION);\n\n                if (option.hasClass('active')) {\n                    // If it's already active then we don't need to do anything.\n                    return;\n                }\n\n                $(e.target).trigger(RemuiblckEvents.COURSE_ANALYTICS_PAGE_FILTER_CHANGE);\n                M.util.set_user_preference('courseanalyticsperpage', option.data('value'));\n                generatePagination(root, option.data('value'));\n            }\n        );\n    };\n\n    /**\n     * Get manage courses filter dropdown selection\n     *\n     * @param  {DOM}    root block root element id\n     * @return {string}      selected per page courses\n     */\n    var getCourseAnalyticsPerPage = function(root) {\n        return $(root).find(SELECTORS.PER_PAGE_FILTER).find(SELECTORS.FILTER_OPTION + '.active').data('value');\n    };\n\n    /**\n     * Initialize event listerns\n     *\n     * @param  {String} root block root element id\n     */\n    function initEvents(root) {\n        // Initialize per page filter events\n        registerCourseAnalyticsPerPageFilter(root);\n\n        // Traverse through page\n        $('body').on('click', root + ' ' + SELECTORS.PAGINATE, function() {\n            if ($(this).is(SELECTORS.NEXT)) {\n                if (pageNumber == maxPage) {\n                    return;\n                }\n                pageNumber++;\n            } else if($(this).is(SELECTORS.PREVIOUS)) {\n                if (pageNumber == 1) {\n                    return;\n                }\n                pageNumber--;\n            } else {\n                return;\n            }\n            var perPage = getCourseAnalyticsPerPage(root);\n            updateBars(root, perPage);\n        });\n\n        //Update chart on courses dropdown change\n        $('body').on('change', root + ' #coursecategorylist', function () {\n            createAnalysisChart(root);\n        });\n    }\n\n    /**\n     * Main method to be initialised for course analytics block\n     *\n     * @param  {String} root block root element id\n     */\n    var init = function(root) {\n        $(document).ready(function() {\n            initEvents(root);\n            if ($(root).find('#analysischart').length) {\n                createAnalysisChart(root);\n            }\n        });\n    };\n\n    return {\n        init: init\n    };\n\n});\n"],"names":["define","$","Ajax","Chart","CustomEvents","RemuiblckEvents","SELECTORS","window","analysisBar","pageNumber","maxPage","updateBars","root","totalBars","limit","perPage","start","end","undefined","labels","length","getStartEnd","find","text","M","util","get_string","to","total","analysisChart","data","datasets","forEach","dataset","update","i","push","index","generatePagination","removeClass","Math","round","addClass","createAnalysisChart","course_id","call","methodname","args","courseid","getAnalysisData","done","response","destroy","error","html","maxactivityname","minactivityname","highest","lowest","average","context","get","getContext","backgroundColor","label","canvas","height","type","options","responsive","maintainAspectRatio","tooltips","enabled","hover","animationDuration","layout","padding","top","legend","position","fontSize","animation","duration","easing","onComplete","chartInstance","this","chart","ctx","font","helpers","fontString","defaults","global","defaultFontSize","defaultFontStyle","defaultFontFamily","textAlign","textBaseline","meta","controller","getDatasetMeta","hidden","bar","fillText","_model","x","y","scales","xAxes","display","gridLines","barThickness","yAxes","ticks","beginAtZero","getCourseAnalyticsPerPage","fail","xhr","status","hide","initEvents","courseAnalyticsPerPageFilterContainer","events","activate","on","e","originalEvent","preventDefault","option","target","closest","hasClass","trigger","COURSE_ANALYTICS_PAGE_FILTER_CHANGE","set_user_preference","registerCourseAnalyticsPerPageFilter","is","init","document","ready"],"mappings":"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"}