define("block_remuiblck/task",["jquery","core/ajax","core/notification","core/templates","core/modal_factory","core/modal_events","core/fragment","block_remuiblck/modal_task_popup","block_remuiblck/events","block_remuiblck/task_filters","block_remuiblck/task_view"],(function($,ajax,Notification,Templates,ModalFactory,ModalEvents,Fragment,ModalTaskPopup,RemuiblckEvents,TaskFilters,TaskView){var SELECTORS_ADD_TASK='[data-region="add-task"]',SELECTORS_TASK='[data-region="task-item"]',SELECTORS_TASK_EDIT='[data-action="edit"]',SELECTORS_TASK_SUBJECT$0=".item-title .panel-heading span",SELECTORS_PANEL=".panel",SELECTORS_PANEL_HEADING=".panel-heading",SELECTORS_PANEL_ACTIONS="panel-actions",SELECTORS_TOASTER_CONTAINER="[aria-task-toasters]",SELECTORS_TOASTER_CONTAINER_ID="aria-task-toasters",SELECTORS_TASK_PROCESSING=".block-processing",PROMISES_CREATE_NEW_TASK=function(settings){return ajax.call([{methodname:"block_remuiblck_create_new_task",args:settings}])[0]},PROMISES_EDIT_TASK=function(settings){return ajax.call([{methodname:"block_remuiblck_edit_task",args:settings}])[0]},PROMISES_COMPLETE_TASK=function(taskid,status){return ajax.call([{methodname:"block_remuiblck_complete_task",args:{id:taskid,status:status}}])[0]},PROMISES_DELETE_TASK=function(taskid){return ajax.call([{methodname:"block_remuiblck_delete_task",args:{id:taskid}}])[0]},PROMISES_NOTIFY_USERS=function(taskid,type){return ajax.call([{methodname:"block_remuiblck_task_notify_users",args:{id:taskid,type:type}}])[0]},FRAGMENTS_GET_TASK_FORM=function(taskid){return Fragment.loadFragment("block_remuiblck","task_form",contextid,{taskid:taskid})},closeTaskPopup=function(modal){modal.hide(),modal.destroy()},deleteTask=function(root,taskid,taskModal){let subject=function(root,taskid){let task=$(root).find(SELECTORS_TASK+'[data-id="'+taskid+'"]');return task?task.find(SELECTORS_TASK_SUBJECT$0).text():taskid}(root,taskid);ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:M.util.get_string("deletetask","block_remuiblck"),body:M.util.get_string("deletetaskmessage","block_remuiblck",subject)},$("#create")).done((function(modal){modal.setSaveButtonText(M.util.get_string("ok","moodle")),modal.getRoot().on(ModalEvents.save,(function(){PROMISES_DELETE_TASK(taskid).done((function(response){if(1==response.status)return closeTaskPopup(modal),closeTaskPopup(taskModal),loadTasks(root),void function(root,position,type,message){0==$(root).find("."+position+SELECTORS_TOASTER_CONTAINER).length&&$(root).append('<div class="toaster '+position+'"'+SELECTORS_TOASTER_CONTAINER_ID+'role="alert"></div>');let newToast=$('<div class="toast toast-just-text '+type+' toast-shadow"><div class="toast-message">'+message+"</div></div>");$(root).find(SELECTORS_TOASTER_CONTAINER).append(newToast),setTimeout((function(){newToast.addClass("show")}),0),setTimeout((function(){newToast.removeClass("show"),setTimeout((function(){newToast.remove()}),250)}),2e3)}(root,"toast-top-center","toast-error",M.util.get_string("taskdeleted","block_remuiblck",subject));Notification.exception({name:response.msg})})).fail(Notification.exception)})).on(ModalEvents.cancel,(function(){closeTaskPopup(modal)})),modal.show()})).fail(Notification.exception)},taskPopup=function(root,taskid){ModalFactory.create({type:ModalTaskPopup.TYPE,templateContext:{new:-1==taskid}},$("#create")).done((function(modal){modal.show(),modal.setBody(FRAGMENTS_GET_TASK_FORM(taskid)),modal.getRoot().on(ModalEvents.hidden,(function(){closeTaskPopup(modal)})).on(RemuiblckEvents.TASK_SAVE,(function(){if(!modal.valid_settings())return;modal.saving();let settings=modal.get_task_settings();-1!=taskid?(settings.id=taskid,PROMISES_EDIT_TASK(settings).done((function(){closeTaskPopup(modal),loadTasks(root)})).fail((function(ex){modal.saving(!1),Notification.exception(ex)}))):PROMISES_CREATE_NEW_TASK(settings).done((function(response){1!=settings.notify?(closeTaskPopup(modal),loadTasks(root)):function(taskid,type){var callback=arguments.length>1&&void 0!==arguments[2]?arguments[2]:null;PROMISES_NOTIFY_USERS(taskid,type).done(callback).fail((function(ex){Notification.exception(ex),null!=callback&&callback()}))}(response,"create",(function(){closeTaskPopup(modal),loadTasks(root)}))})).fail((function(ex){modal.saving(!1),Notification.exception(ex)}))})).on(RemuiblckEvents.TASK_DELETE,(function(){deleteTask(root,taskid,modal)})).on(RemuiblckEvents.TASK_CANCEL,(function(){closeTaskPopup(modal)}))}))},loadTasks=function(root){TaskView.loadTasks(root,TaskFilters.getTaskDuration(root),TaskFilters.getTaskStatus(root))},initialiseEvents=function(root){$("body").on("click",SELECTORS_ADD_TASK,(function(){taskPopup(root,-1)})).on("click",root+" "+SELECTORS_TASK,(function(e){$(e.target).is("input")?function(root,taskid,status){TaskView.toggleTaskProcessing(root,!0),PROMISES_COMPLETE_TASK(taskid,status).done((function(response){1!=response.status?($(root+" "+SELECTORS_TASK+'[data-id="'+taskid+'"]').find("input").prop("checked",!status),Notification.exception({name:response.msg}),TaskView.toggleTaskProcessing(root)):loadTasks(root)})).fail((function(ex){Notification.exception(ex),$(root+" "+SELECTORS_TASK+'[data-id="'+taskid+'"]').find("input").prop("checked",!status),TaskView.toggleTaskProcessing(root)}))}(root,$(this).data("id"),$(e.target).is(":checked")):$(e.target).is(SELECTORS_TASK_SUBJECT$0)||($(e.target).is(SELECTORS_TASK_EDIT)||$(e.target).parent().is(SELECTORS_TASK_EDIT))&&taskPopup(root,$(this).data("id"))}))};return{init:function(root){$(document).ready((function(){initialiseEvents(root),function(root){let button=$(root).find(SELECTORS_ADD_TASK).detach(),panelHeading=$(root).closest(SELECTORS_PANEL).find(SELECTORS_PANEL_HEADING),panelActions=$(panelHeading).find("."+SELECTORS_PANEL_ACTIONS);0==panelActions.length&&(panelActions=$('<div class="'+SELECTORS_PANEL_ACTIONS+'"></div>'),panelHeading.append(panelActions)),panelActions.prepend(button),button.removeClass("d-none");let taskProcessing=$(root).find(SELECTORS_TASK_PROCESSING).detach();$(panelHeading).parent(SELECTORS_PANEL).prepend(taskProcessing)}(root)})),TaskView.init(root),TaskFilters.init(root)}}}));

//# sourceMappingURL=task.min.js.map